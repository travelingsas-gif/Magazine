

import React, { useState, useMemo, useEffect } from 'react';
import { 
  Building2, Box, Users, ShoppingCart, LogOut, Menu, X, 
  Plus, Edit, Trash2, Camera, Check, Send, AlertCircle, FileText, Search,
  Clock, Bell, Truck, MapPin, Save, XCircle, Mail, Shirt, AlertTriangle, UserCheck, Loader, RefreshCw, Database, Image as ImageIcon, Minus, Key, Wrench, CheckCircle2, Download, ClipboardList, Calendar, Filter, X as XIcon
} from 'lucide-react';
import { 
  Role, User, Product, Structure, InventoryReport, Order, 
  OrderStatus, InventoryItem, ItemType, DamageReport, LinenIssueReport, LinenIssueItem 
} from './types';
import { analyzeInventoryImage } from './services/geminiService';
import { supabase } from './supabaseClient';
import { SignaturePad } from './components/SignaturePad';

// --- Helpers to map snake_case (DB) to camelCase (App) ---
const mapUser = (u: any): User => ({ id: u.id, name: u.name, email: u.email, role: u.role as Role, password: u.password });
const mapStructure = (s: any): Structure => ({ id: s.id, name: s.name, address: s.address, accessCodes: s.access_codes, imageUrl: s.image_url });
const mapProduct = (p: any): Product => ({ id: p.id, name: p.name, category: p.category, unit: p.unit, type: p.type });
const mapInventory = (i: any): InventoryReport => ({ id: i.id, structureId: i.structure_id, operatorId: i.operator_id, date: i.date, items: i.items, signatureUrl: i.signature_url, photoUrl: i.photo_url, notes: i.notes, type: i.type });
const mapOrder = (o: any): Order => ({ id: o.id, structureId: o.structure_id, requesterId: o.requester_id, dateCreated: o.date_created, dateSent: o.date_sent, sentToEmail: o.sent_to_email, items: o.items, status: o.status, type: o.type });
const mapDamageReport = (d: any): DamageReport => ({ id: d.id, structureId: d.structure_id, reporterId: d.reporter_id, date: d.date, items: d.items, notes: d.notes, status: d.status });
const mapLinenReport = (l: any): LinenIssueReport => ({ id: l.id, structureId: l.structure_id, reporterId: l.reporter_id, date: l.date, items: l.items, notes: l.notes });

// --- Main App ---
const App: React.FC = () => {
  const [currentUser, setCurrentUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [showSuccess, setShowSuccess] = useState(false);
  const [confirmModal, setConfirmModal] = useState<{ isOpen: boolean, title: string, message: string, onConfirm: () => void, confirmText?: string } | null>(null);
  
  const [users, setUsers] = useState<User[]>([]);
  const [products, setProducts] = useState<Product[]>([]);
  const [structures, setStructures] = useState<Structure[]>([]);
  const [inventories, setInventories] = useState<InventoryReport[]>([]);
  const [orders, setOrders] = useState<Order[]>([]);
  const [damageReports, setDamageReports] = useState<DamageReport[]>([]);
  const [linenReports, setLinenReports] = useState<LinenIssueReport[]>([]);

  const [currentView, setCurrentView] = useState<string>('login');
  const [selectedStructureId, setSelectedStructureId] = useState<string | null>(null);
  const [activeItemType, setActiveItemType] = useState<ItemType>('PRODUCT'); 
  const [isMenuOpen, setIsMenuOpen] = useState(false);

  const fetchData = async () => {
    try {
       const [resUsers, resProds, resStructs, resInv, resOrd, resDmg, resLinen] = await Promise.all([
         supabase.from('users').select('*'),
         supabase.from('products').select('*').order('name'),
         supabase.from('structures').select('*'),
         supabase.from('inventories').select('*'),
         supabase.from('orders').select('*'),
         supabase.from('damage_reports').select('*'),
         supabase.from('linen_reports').select('*') 
       ]);

       if (resUsers.data) setUsers(resUsers.data.map(mapUser));
       if (resProds.data) setProducts(resProds.data.map(mapProduct));
       if (resStructs.data) setStructures(resStructs.data.map(mapStructure));
       if (resInv.data) setInventories(resInv.data.map(mapInventory));
       if (resOrd.data) setOrders(resOrd.data.map(mapOrder));
       if (resDmg.data) setDamageReports(resDmg.data.map(mapDamageReport));
       if (resLinen.data) setLinenReports(resLinen.data.map(mapLinenReport));

    } catch (err: any) {
      console.error("Error fetching data:", err);
      setError("Impossibile connettersi al database.");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => { fetchData(); }, []);

  const triggerSuccess = () => {
    setShowSuccess(true);
    setTimeout(() => setShowSuccess(false), 2000);
  };
  
  const openConfirm = (title: string, message: string, onConfirm: () => void, confirmText: string = 'Conferma') => {
    setConfirmModal({ isOpen: true, title, message, onConfirm, confirmText });
  };

  const handleLogin = (email: string, pass: string) => {
    const user = users.find(u => u.email === email && u.password === pass);
    if (user) {
      setCurrentUser(user);
      setCurrentView(user.role === Role.SUPPLIER ? 'supplier-dashboard' : 'dashboard');
    } else {
      alert('Credenziali non valide');
    }
  };

  const handleLogout = () => { setCurrentUser(null); setCurrentView('login'); setIsMenuOpen(false); };

  const getUnreadOrdersCount = (type?: ItemType) => {
    if (currentUser?.role === Role.RECEPTION || currentUser?.role === Role.ADMIN) {
      return orders.filter(o => o.status === OrderStatus.PENDING && (!type || o.type === type)).length;
    }
    return 0;
  };

  if (loading) return <div className="min-h-screen flex items-center justify-center bg-gray-50 flex-col gap-4"><Loader className="animate-spin text-emerald-600" size={32} /><p className="text-gray-500 font-medium mt-2">Caricamento...</p></div>;
  if (error) return <div className="min-h-screen flex items-center justify-center bg-red-50 p-4"><div className="bg-white p-6 rounded-lg shadow-lg border-l-4 border-red-500 max-w-md"><h2 className="text-xl font-bold text-red-600 mb-2">Errore di Connessione</h2><p className="text-gray-600 mb-4">{error}</p><button onClick={() => window.location.reload()} className="bg-gray-200 px-4 py-2 rounded">Riprova</button></div></div>;
  if (!currentUser || currentView === 'login') return <LoginView onLogin={handleLogin} />;

  const renderContent = () => {
    switch (currentView) {
      case 'dashboard':
        return <DashboardView structures={structures} onSelectStructure={(id) => { setSelectedStructureId(id); setCurrentView('structure-detail'); }} role={currentUser.role} pendingOrdersCount={getUnreadOrdersCount()} onNavigateToOrders={() => setCurrentView('orders-products')} />;
      case 'supplier-dashboard':
        return <SupplierDashboardView orders={orders} structures={structures} products={products} users={users} />;
      case 'structure-detail':
        return <StructureDetailView structureId={selectedStructureId!} currentUser={currentUser} inventories={inventories} orders={orders} products={products} structures={structures} users={users} damageReports={damageReports} onBack={() => setCurrentView('dashboard')} onNewInventory={(type) => { setActiveItemType(type); setCurrentView('inventory-new'); }} onRequestOrder={(type) => { setActiveItemType(type); setCurrentView('order-new'); }} onReportDamage={(type) => { setActiveItemType(type); setCurrentView('damage-report-new'); }} onLinenIssue={() => setCurrentView('linen-issue-new')} />;
      case 'inventory-new':
        return <NewInventoryView structureId={selectedStructureId!} currentUser={currentUser} products={products} type={activeItemType} onSave={async (inv) => { openConfirm("Salva Inventario", "Confermi il salvataggio dei dati?", async () => { const { error } = await supabase.from('inventories').insert({ ...inv, structure_id: inv.structureId, operator_id: inv.operatorId, signature_url: inv.signatureUrl, photo_url: inv.photoUrl }); if (!error) { fetchData(); setCurrentView('structure-detail'); triggerSuccess(); } setConfirmModal(null); }); }} onCancel={() => setCurrentView('structure-detail')} />;
      case 'order-new':
        return <NewOrderView structureId={selectedStructureId!} currentUser={currentUser} products={products} inventories={inventories} type={activeItemType} onSave={async (ord) => { openConfirm("Invia Ordine", "Inoltrare la richiesta alla reception per approvazione?", async () => { const { error } = await supabase.from('orders').insert({ ...ord, structure_id: ord.structureId, requester_id: ord.requesterId, date_created: ord.dateCreated }); if (!error) { fetchData(); setCurrentView('structure-detail'); triggerSuccess(); } setConfirmModal(null); }, "Invia"); }} onCancel={() => setCurrentView('structure-detail')} />;
      case 'damage-report-new':
        return <NewDamageReportView structureId={selectedStructureId!} currentUser={currentUser} products={products} type={activeItemType} onSave={async (rep) => { openConfirm("Invia Segnalazione", "Confermi l'invio della segnalazione di guasto?", async () => { const { error } = await supabase.from('damage_reports').insert({ ...rep, structure_id: rep.structureId, reporter_id: rep.reporterId }); if (!error) { fetchData(); setCurrentView('structure-detail'); triggerSuccess(); } setConfirmModal(null); }, "Invia"); }} onCancel={() => setCurrentView('structure-detail')} />;
      case 'linen-issue-new':
        return <NewLinenIssueView structureId={selectedStructureId!} currentUser={currentUser} products={products} onSave={async (rep) => { openConfirm("Salva Report Biancheria", "Confermi il salvataggio del report?", async () => { const { error } = await supabase.from('linen_reports').insert({ ...rep, structure_id: rep.structureId, reporter_id: rep.reporterId }); if (!error) { fetchData(); setCurrentView('structure-detail'); triggerSuccess(); } else { console.error("Errore salvataggio report:", error); alert("Errore: impossibile salvare il report. Controlla la console."); } setConfirmModal(null); }); }} onCancel={() => setCurrentView('structure-detail')} />;
      case 'linen-issue-log':
        return <LinenIssuesLogView reports={linenReports} structures={structures} products={products} users={users} onDeleteReport={async (id) => { openConfirm("Elimina Report", "Sei sicuro di voler eliminare questo report?", async () => { const { error } = await supabase.from('linen_reports').delete().eq('id', id); if(!error) { fetchData(); triggerSuccess(); } setConfirmModal(null); }, "Elimina"); }} />;
      case 'orders-products': 
        return <ManageOrdersView orders={orders} structures={structures} products={products} users={users} currentUser={currentUser} targetType="PRODUCT" onUpdateOrder={async (updatedOrder) => { const { error } = await supabase.from('orders').update({ items: updatedOrder.items, status: updatedOrder.status, date_sent: updatedOrder.dateSent, sent_to_email: updatedOrder.sentToEmail }).eq('id', updatedOrder.id); if(!error) { fetchData(); triggerSuccess(); } }} onDeleteOrder={async (id) => { openConfirm("Elimina Ordine", "Sei sicuro?", async () => { const { error } = await supabase.from('orders').delete().eq('id', id); if(!error) { fetchData(); triggerSuccess(); } setConfirmModal(null); }, "Elimina"); }} />;
      case 'orders-linen': 
        return <ManageOrdersView orders={orders} structures={structures} products={products} users={users} currentUser={currentUser} targetType="LINEN" onUpdateOrder={async (updatedOrder) => { const { error } = await supabase.from('orders').update({ items: updatedOrder.items, status: updatedOrder.status, date_sent: updatedOrder.dateSent }).eq('id', updatedOrder.id); if(!error) { fetchData(); triggerSuccess(); } }} onDeleteOrder={async (id) => { openConfirm("Elimina Ordine", "Sei sicuro?", async () => { const { error } = await supabase.from('orders').delete().eq('id', id); if(!error) { fetchData(); triggerSuccess(); } setConfirmModal(null); }, "Elimina"); }} />;
      case 'users':
        return <UserManagementView users={users} onAddUser={async (newUser) => { const { error } = await supabase.from('users').insert({ ...newUser }); if (!error) { fetchData(); triggerSuccess(); } }} onDeleteUser={async (id) => { openConfirm("Elimina Utente", `Sei sicuro di voler eliminare questo utente?`, async () => { const { error } = await supabase.from('users').delete().eq('id', id); if(!error) { fetchData(); triggerSuccess(); } setConfirmModal(null); }, "Elimina"); }} />;
      case 'products':
        return <ProductManagementView products={products} onAddProduct={async (newP) => { const { error } = await supabase.from('products').insert({ ...newP }); if (!error) { fetchData(); triggerSuccess(); } }} onDeleteProduct={async (id) => { openConfirm("Elimina Prodotto", "Sei sicuro di voler eliminare questo prodotto?", async () => { const { error } = await supabase.from('products').delete().eq('id', id); if(!error) { fetchData(); triggerSuccess(); } setConfirmModal(null); }, "Elimina"); }} />;
      default:
        return <DashboardView structures={structures} onSelectStructure={() => {}} role={currentUser.role} pendingOrdersCount={0} onNavigateToOrders={() => {}} />;
    }
  };

  return (
    <div className="min-h-screen bg-gray-50 flex flex-col md:flex-row">
      {showSuccess && <div className="fixed top-5 left-1/2 -translate-x-1/2 z-[100] bg-emerald-600 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-2 animate-bounce"><Check size={20} /> <span className="font-bold">Fatto!</span></div>}
      {confirmModal?.isOpen && <ActionConfirmModal {...confirmModal} onCancel={() => setConfirmModal(null)} />}
      
      <div className="md:hidden bg-white shadow-sm p-4 flex justify-between items-center sticky top-0 z-20">
        <h1 className="text-xl font-bold text-emerald-700">CleanManage</h1>
        <div className="flex items-center gap-4">
           {getUnreadOrdersCount() > 0 && currentUser.role !== Role.SUPPLIER && (<button onClick={() => setCurrentView('orders-products')} className="relative text-gray-600"><Bell size={24} /><span className="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-4 h-4 flex items-center justify-center rounded-full animate-pulse">{getUnreadOrdersCount()}</span></button>)}
           <button onClick={() => setIsMenuOpen(!isMenuOpen)}>{isMenuOpen ? <X /> : <Menu />}</button>
        </div>
      </div>

      <aside className={`fixed inset-y-0 left-0 transform ${isMenuOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 transition duration-200 ease-in-out w-64 bg-slate-900 text-white p-6 flex flex-col z-50`}>
        <div className="hidden md:flex items-center gap-2 mb-10"><Building2 className="text-emerald-400" /> <span className="text-xl font-bold">CleanManage</span></div>
        <div className="mb-6"><div className="text-xs text-slate-400 uppercase font-bold tracking-wider mb-2">Utente</div><div className="flex items-center gap-2"><div className="w-8 h-8 rounded-full bg-emerald-600 flex items-center justify-center text-sm font-bold">{currentUser.name.charAt(0)}</div><div><p className="text-sm font-medium">{currentUser.name}</p><p className="text-xs text-slate-400 capitalize">{currentUser.role}</p></div></div></div>
        <nav className="flex-1 space-y-2">
          {currentUser.role === Role.SUPPLIER ? (<NavItem icon={<Truck size={20} />} label="Pannello Fornitore" active={currentView === 'supplier-dashboard'} onClick={() => { setCurrentView('supplier-dashboard'); setIsMenuOpen(false); }} />) : (<>
              <NavItem icon={<Building2 size={20} />} label="Zone / Strutture" active={currentView === 'dashboard' || currentView === 'structure-detail'} onClick={() => { setCurrentView('dashboard'); setIsMenuOpen(false); }} />
              <div className="pt-4 pb-2 text-xs text-slate-500 uppercase font-bold tracking-wider">Operatività</div>
              <NavItem icon={<ShoppingCart size={20} />} label="Ordini Prodotti" badge={getUnreadOrdersCount('PRODUCT')} active={currentView === 'orders-products'} onClick={() => { setCurrentView('orders-products'); setIsMenuOpen(false); }} />
              <NavItem icon={<Shirt size={20} />} label="Ordini Biancheria" badge={getUnreadOrdersCount('LINEN')} active={currentView === 'orders-linen'} onClick={() => { setCurrentView('orders-linen'); setIsMenuOpen(false); }} />
              <NavItem icon={<ClipboardList size={20} />} label="Log Biancheria" active={currentView === 'linen-issue-log'} onClick={() => { setCurrentView('linen-issue-log'); setIsMenuOpen(false); }} />
              {currentUser.role === Role.ADMIN && (<>
                  <div className="pt-4 pb-2 text-xs text-slate-500 uppercase font-bold tracking-wider">Amministrazione</div>
                  <NavItem icon={<Box size={20} />} label="Prodotti" active={currentView === 'products'} onClick={() => { setCurrentView('products'); setIsMenuOpen(false); }} />
                  <NavItem icon={<Users size={20} />} label="Utenti" active={currentView === 'users'} onClick={() => { setCurrentView('users'); setIsMenuOpen(false); }} />
              </>)}
          </>)}
        </nav>
        <button onClick={handleLogout} className="mt-auto flex items-center gap-2 text-slate-400 hover:text-white transition-colors"><LogOut size={20} /><span>Esci</span></button>
      </aside>
      <main className="flex-1 p-4 md:p-8 overflow-y-auto h-screen bg-gray-100">{renderContent()}</main>
    </div>
  );
};

// --- Sub-Components ---
const NavItem: React.FC<{ icon: any, label: string, active?: boolean, onClick: () => void, badge?: number }> = ({ icon, label, active, onClick, badge }) => (<button onClick={onClick} className={`w-full flex items-center justify-between p-3 rounded-lg transition-colors ${active ? 'bg-emerald-600 text-white' : 'hover:bg-slate-800 text-slate-300'}`}><div className="flex items-center gap-3">{icon}<span>{label}</span></div>{badge ? <span className="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full animate-pulse">{badge}</span> : null}</button>);
const ActionConfirmModal: React.FC<{ onConfirm: () => void; onCancel: () => void; title: string; message: string; confirmText?: string; }> = ({ onConfirm, onCancel, title, message, confirmText = 'Conferma' }) => (<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4 animate-fade-in"><div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full"><h3 className="text-xl font-bold mb-2 text-gray-800">{title}</h3><p className="mb-6 text-gray-600">{message}</p><div className="flex justify-end gap-3"><button onClick={onCancel} className="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition font-medium">Annulla</button><button onClick={onConfirm} className={`px-4 py-2 text-white rounded font-bold shadow-sm transition ${confirmText.toLowerCase() === 'elimina' ? 'bg-red-600 hover:bg-red-700' : 'bg-emerald-600 hover:bg-emerald-700'}`}>{confirmText}</button></div></div></div>);
const LoginView: React.FC<{ onLogin: (e: string, p: string) => void }> = ({ onLogin }) => { const [email, setEmail] = useState(''); const [password, setPassword] = useState(''); return (<div className="min-h-screen flex items-center justify-center bg-gray-100 p-4"><div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md"><div className="text-center mb-8"><div className="bg-emerald-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><Building2 className="text-emerald-600" size={32} /></div><h2 className="text-2xl font-bold text-gray-800">CleanManage</h2><p className="text-sm text-gray-500 mt-2">Gestione Operativa & Logistica</p></div><form onSubmit={(e) => { e.preventDefault(); onLogin(email, password); }} className="space-y-4"><div><label className="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" required className="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none transition" value={email} onChange={e => setEmail(e.target.value)} /></div><div><label className="block text-sm font-medium text-gray-700 mb-1">Password</label><input type="password" required className="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none transition" value={password} onChange={e => setPassword(e.target.value)} /></div><button type="submit" className="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg transition">Accedi</button></form></div></div>); };
const DashboardView: React.FC<{ structures: Structure[]; onSelectStructure: (id: string) => void; role: Role; pendingOrdersCount: number; onNavigateToOrders: () => void; }> = ({ structures, onSelectStructure, role, pendingOrdersCount, onNavigateToOrders }) => ( <div className="max-w-6xl mx-auto"><div className="flex justify-between items-center mb-8"><div><h1 className="text-3xl font-bold text-gray-800">Zone e Strutture</h1><p className="text-gray-500 mt-1">Gestisci le proprietà e monitora lo stato.</p></div></div>{pendingOrdersCount > 0 && (<div onClick={onNavigateToOrders} className="cursor-pointer bg-orange-50 border border-orange-200 p-4 rounded-xl mb-8 flex items-center justify-between hover:bg-orange-100 transition shadow-sm"><div className="flex items-center gap-3"><div className="bg-orange-100 p-2 rounded-full text-orange-600"><ShoppingCart size={24} /></div><div><h3 className="font-bold text-orange-800">Ci sono ordini in attesa!</h3><p className="text-orange-700 text-sm">Hai {pendingOrdersCount} richieste da approvare.</p></div></div><div className="bg-white px-4 py-2 rounded-lg text-orange-600 font-bold text-sm shadow-sm">Vedi Ordini</div></div>)}<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">{structures.map(structure => (<div key={structure.id} className="group bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 border border-gray-100 overflow-hidden cursor-pointer" onClick={() => onSelectStructure(structure.id)}><div className="h-48 bg-gray-200 relative overflow-hidden"><img src={structure.imageUrl || `https://picsum.photos/seed/${structure.id}/800/600`} alt={structure.name} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" /><div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent flex items-end p-6"><h3 className="text-white font-bold text-xl drop-shadow-md">{structure.name}</h3></div></div><div className="p-6"><div className="flex items-start gap-3 mb-4 text-gray-500"><MapPin size={18} className="mt-1 flex-shrink-0 text-emerald-500" /><p className="text-sm leading-relaxed">{structure.address}</p></div><div className="flex justify-between items-center border-t border-gray-100 pt-4 mt-2"><span className="text-xs font-bold text-gray-400 uppercase tracking-wider">Gestisci</span><div className="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center group-hover:bg-emerald-500 group-hover:text-white transition-colors"><Users size={16} /></div></div></div></div>))}{structures.length === 0 && (<div className="col-span-full text-center py-20 text-gray-400 bg-white rounded-2xl border border-dashed border-gray-300"><Building2 size={48} className="mx-auto mb-4 opacity-50" /><p>Nessuna struttura presente.</p></div>)}</div></div>);
const StructureDetailView: React.FC<{ structureId: string; currentUser: User; inventories: InventoryReport[]; orders: Order[]; products: Product[]; structures: Structure[]; users: User[]; damageReports: DamageReport[]; onBack: () => void; onNewInventory: (type: ItemType) => void; onRequestOrder: (type: ItemType) => void; onReportDamage: (type: ItemType) => void; onLinenIssue: () => void; }> = ({ structureId, onBack, onNewInventory, onRequestOrder, onReportDamage, onLinenIssue, structures }) => { const structure = structures.find(s => s.id === structureId); if (!structure) return <div>Struttura non trovata</div>; return (<div className="max-w-5xl mx-auto pb-20"><button onClick={onBack} className="flex items-center gap-2 text-gray-500 mb-4 hover:text-emerald-600 transition"><Building2 size={18} /> Torna alle Strutture</button><div className="bg-white rounded-xl shadow-sm p-6 mb-6"><h1 className="text-3xl font-bold text-gray-800">{structure.name}</h1><p className="text-gray-500 flex items-center gap-2 mt-1"><MapPin size={16} /> {structure.address}</p><p className="mt-2 text-sm text-gray-700 bg-gray-100 border border-gray-200 px-3 py-1 rounded inline-block"><b>Accesso:</b> {structure.accessCodes}</p></div><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div onClick={() => onNewInventory('PRODUCT')} className="cursor-pointer bg-emerald-50 border border-emerald-100 p-6 rounded-xl hover:shadow-md transition"><div className="bg-white w-12 h-12 rounded-full flex items-center justify-center text-emerald-600 mb-3 shadow-sm"><Box /></div><h3 className="font-bold text-lg text-emerald-900">Inventario Prodotti</h3><p className="text-emerald-700 text-sm">Controlla e registra i consumabili</p></div><div onClick={() => onNewInventory('LINEN')} className="cursor-pointer bg-indigo-50 border border-indigo-100 p-6 rounded-xl hover:shadow-md transition"><div className="bg-white w-12 h-12 rounded-full flex items-center justify-center text-indigo-600 mb-3 shadow-sm"><Shirt /></div><h3 className="font-bold text-lg text-indigo-900">Conta Biancheria</h3><p className="text-indigo-700 text-sm">Gestione lavanderia e cambi</p></div><div onClick={() => onRequestOrder('PRODUCT')} className="cursor-pointer bg-orange-50 border border-orange-100 p-6 rounded-xl hover:shadow-md transition"><div className="bg-white w-12 h-12 rounded-full flex items-center justify-center text-orange-600 mb-3 shadow-sm"><ShoppingCart /></div><h3 className="font-bold text-lg text-orange-900">Ordina Forniture</h3><p className="text-orange-700 text-sm">Richiedi prodotti mancanti</p></div><div onClick={() => onRequestOrder('LINEN')} className="cursor-pointer bg-sky-50 border border-sky-100 p-6 rounded-xl hover:shadow-md transition"><div className="bg-white w-12 h-12 rounded-full flex items-center justify-center text-sky-600 mb-3 shadow-sm"><Shirt /></div><h3 className="font-bold text-lg text-sky-900">Ordina Biancheria</h3><p className="text-sky-700 text-sm">Richiedi set biancheria</p></div><div onClick={onLinenIssue} className="cursor-pointer bg-purple-50 border border-purple-100 p-6 rounded-xl hover:shadow-md transition"><div className="bg-white w-12 h-12 rounded-full flex items-center justify-center text-purple-600 mb-3 shadow-sm"><ClipboardList /></div><h3 className="font-bold text-lg text-purple-900">Biancheria Sporca/Rotta</h3><p className="text-purple-700 text-sm">Dichiara biancheria inutilizzata</p></div><div onClick={() => onReportDamage('PRODUCT')} className="cursor-pointer bg-red-50 border border-red-100 p-6 rounded-xl hover:shadow-md transition"><div className="bg-white w-12 h-12 rounded-full flex items-center justify-center text-red-600 mb-3 shadow-sm"><AlertTriangle /></div><h3 className="font-bold text-lg text-red-900">Segnala Guasto</h3><p className="text-red-700 text-sm">Manutenzione e danni</p></div></div></div>); };
const NewLinenIssueView: React.FC<{ structureId: string; currentUser: User; products: Product[]; onSave: (report: any) => void; onCancel: () => void; }> = ({ structureId, currentUser, products, onSave, onCancel }) => { const linenProducts = products.filter(p => p.type === 'LINEN'); const [items, setItems] = useState<Record<string, { dirty: number, broken: number, unused: number }>>({}); const [notes, setNotes] = useState(''); const handleQtyChange = (pid: string, field: 'dirty' | 'broken' | 'unused', val: number) => { setItems(prev => ({ ...prev, [pid]: { ...(prev[pid] || { dirty: 0, broken: 0, unused: 0 }), [field]: val } })); }; const handleSubmit = () => { const reportItems: LinenIssueItem[] = Object.entries(items).map(([pid, counts]) => ({ productId: pid, dirty: counts.dirty || 0, broken: counts.broken || 0, unused: counts.unused || 0 })).filter(i => i.dirty > 0 || i.broken > 0 || i.unused > 0); if (reportItems.length === 0) { alert("Inserisci almeno una quantità."); return; } onSave({ id: `lin-${Date.now()}`, structureId, reporterId: currentUser.id, date: new Date().toISOString(), items: reportItems, notes }); }; return (<div className="max-w-3xl mx-auto bg-white p-6 rounded-xl shadow-lg pb-20"><h2 className="text-2xl font-bold mb-2 flex items-center gap-2 text-purple-700"><ClipboardList /> Biancheria Sporca/Rotta</h2><p className="text-gray-500 mb-6">Dichiara la biancheria che viene ritirata o che non è stata utilizzata.</p><div className="space-y-4 mb-6"><div className="grid grid-cols-12 gap-2 text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 px-2"><div className="col-span-5">Prodotto</div><div className="col-span-2 text-center text-orange-600">Sporco</div><div className="col-span-2 text-center text-red-600">Rotto</div><div className="col-span-2 text-center text-blue-600">Inutilizzato</div></div>{linenProducts.map(p => { const current = items[p.id] || { dirty: 0, broken: 0, unused: 0 }; return (<div key={p.id} className="grid grid-cols-12 gap-2 items-center border-b border-gray-100 pb-3"><div className="col-span-5 font-medium text-sm">{p.name} <span className="text-xs text-gray-400 font-normal">({p.unit})</span></div><div className="col-span-2"><input type="number" min="0" className="w-full border border-orange-200 rounded p-1 text-center bg-orange-50" value={current.dirty || ''} placeholder="0" onChange={e => handleQtyChange(p.id, 'dirty', parseInt(e.target.value)||0)} /></div><div className="col-span-2"><input type="number" min="0" className="w-full border border-red-200 rounded p-1 text-center bg-red-50" value={current.broken || ''} placeholder="0" onChange={e => handleQtyChange(p.id, 'broken', parseInt(e.target.value)||0)} /></div><div className="col-span-2"><input type="number" min="0" className="w-full border border-blue-200 rounded p-1 text-center bg-blue-50" value={current.unused || ''} placeholder="0" onChange={e => handleQtyChange(p.id, 'unused', parseInt(e.target.value)||0)} /></div></div>) })}</div><textarea className="w-full border p-3 rounded-lg mb-6 text-sm" rows={2} placeholder="Note aggiuntive..." value={notes} onChange={e => setNotes(e.target.value)} /><div className="flex gap-3"><button onClick={handleSubmit} className="flex-1 bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700">Salva Report</button><button onClick={onCancel} className="px-6 bg-gray-100 text-gray-700 rounded-lg font-medium">Annulla</button></div></div>); };
const LinenIssuesLogView: React.FC<{ reports: LinenIssueReport[]; structures: Structure[]; products: Product[]; users: User[]; onDeleteReport: (id: string) => void; }> = ({ reports, structures, products, users, onDeleteReport }) => { const [startDate, setStartDate] = useState(''); const [endDate, setEndDate] = useState(''); const filteredReports = useMemo(() => { let res = [...reports]; if (startDate) res = res.filter(r => new Date(r.date) >= new Date(startDate)); if (endDate) { const end = new Date(endDate); end.setHours(23, 59, 59); res = res.filter(r => new Date(r.date) <= end); } return res.sort((a,b) => new Date(b.date).getTime() - new Date(a.date).getTime()); }, [reports, startDate, endDate]); return (<div className="max-w-6xl mx-auto"><div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold flex items-center gap-2"><ClipboardList /> Log Biancheria</h2></div><div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6 flex flex-wrap gap-4 items-end"><div><label className="block text-xs font-bold text-gray-500 mb-1">Da:</label><input type="date" className="border p-2 rounded text-sm" value={startDate} onChange={e => setStartDate(e.target.value)} /></div><div><label className="block text-xs font-bold text-gray-500 mb-1">A:</label><input type="date" className="border p-2 rounded text-sm" value={endDate} onChange={e => setEndDate(e.target.value)} /></div><div className="pb-2 text-sm text-gray-400">{filteredReports.length} report trovati</div></div><div className="space-y-4">{filteredReports.map(report => { const struct = structures.find(s => s.id === report.structureId); const reporter = users.find(u => u.id === report.reporterId); return (<div key={report.id} className="bg-white rounded-lg shadow-sm border border-gray-200 p-4"><div className="flex justify-between items-start border-b border-gray-100 pb-2 mb-2"><div><div className="font-bold text-lg text-gray-800">{struct?.name}</div><div className="text-xs text-gray-500">{new Date(report.date).toLocaleString()} • {reporter?.name}</div></div><button onClick={() => onDeleteReport(report.id)} className="text-red-400 hover:text-red-600 p-1"><Trash2 size={16} /></button></div><div className="overflow-x-auto"><table className="w-full text-sm text-left"><thead><tr className="text-gray-400 text-xs uppercase"><th className="font-medium py-1">Prodotto</th><th className="font-medium py-1 text-orange-600">Sporco</th><th className="font-medium py-1 text-red-600">Rotto</th><th className="font-medium py-1 text-blue-600">Inutilizzato</th></tr></thead><tbody>{report.items.map(item => { const prod = products.find(p => p.id === item.productId); return (<tr key={item.productId} className="border-b border-gray-50 last:border-0"><td className="py-1 font-medium text-gray-700">{prod?.name}</td><td className="py-1 font-mono">{item.dirty || '-'}</td><td className="py-1 font-mono">{item.broken || '-'}</td><td className="py-1 font-mono">{item.unused || '-'}</td></tr>) })}</tbody></table></div>{report.notes && <div className="mt-2 text-xs text-gray-500 italic bg-gray-50 p-2 rounded">Note: {report.notes}</div>}</div>); })} {filteredReports.length === 0 && <p className="text-center text-gray-400 py-10">Nessun dato trovato per il periodo selezionato.</p>}</div></div>); };
const NewInventoryView: React.FC<{ structureId: string; currentUser: User; products: Product[]; type: ItemType; onSave: (inv: any) => void; onCancel: () => void; }> = ({ structureId, currentUser, products, type, onSave, onCancel }) => { const filteredProducts = products.filter(p => p.type === type); const [quantities, setQuantities] = useState<Record<string, number>>({}); const [notes, setNotes] = useState(''); const [signature, setSignature] = useState<string | null>(null); const [isAnalyzing, setIsAnalyzing] = useState(false); const handleQuantityChange = (pid: string, val: number) => { setQuantities(prev => ({ ...prev, [pid]: val })); }; const handleImageAnalysis = async (e: React.ChangeEvent<HTMLInputElement>) => { const file = e.target.files?.[0]; if (file) { setIsAnalyzing(true); const reader = new FileReader(); reader.onloadend = async () => { const base64 = reader.result as string; const results = await analyzeInventoryImage(base64, filteredProducts); const newQuantities = { ...quantities }; // Fix: Remove explicit 'any' type to allow TypeScript to infer the correct type from the service.
results.forEach((item) => { const prod = filteredProducts.find(p => p.name.toLowerCase() === item.productName?.toLowerCase()); if (prod) { newQuantities[prod.id] = item.estimatedQuantity; } }); setQuantities(newQuantities); setIsAnalyzing(false); }; reader.readAsDataURL(file); } }; const handleSubmit = () => { if (!signature) { alert("La firma è obbligatoria."); return; } const items: InventoryItem[] = Object.entries(quantities).filter(([_, q]) => q > 0).map(([pid, q]) => ({ productId: pid, quantity: q })); if (items.length === 0) { alert("Inserisci almeno una quantità."); return; } onSave({ id: `inv-${Date.now()}`, structureId, operatorId: currentUser.id, date: new Date().toISOString(), items, signatureUrl: signature, notes, type }); }; return (<div className="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow-lg"><h2 className="text-2xl font-bold mb-6 flex items-center gap-2">{type === 'PRODUCT' ? <Box className="text-emerald-600" /> : <Shirt className="text-indigo-600" />} Nuovo Inventario {type === 'PRODUCT' ? 'Prodotti' : 'Biancheria'}</h2><div className="bg-blue-50 p-4 rounded-lg mb-6 border border-blue-100"><label className="flex items-center gap-3 cursor-pointer"><div className="bg-blue-600 text-white p-2 rounded-full">{isAnalyzing ? <Loader className="animate-spin" size={20}/> : <Camera size={20}/>}</div><div><span className="font-bold text-blue-900 block">Compilazione Automatica AI</span><span className="text-xs text-blue-700">Carica una foto per contare automaticamente.</span></div><input type="file" accept="image/*" className="hidden" onChange={handleImageAnalysis} disabled={isAnalyzing} /></label></div><div className="space-y-4 mb-6 max-h-[400px] overflow-y-auto pr-2">{filteredProducts.map(p => (<div key={p.id} className="flex justify-between items-center p-3 hover:bg-gray-50 rounded border-b border-gray-100"><div><p className="font-medium text-gray-800">{p.name}</p><p className="text-xs text-gray-400">{p.category}</p></div><div className="flex items-center gap-2"><input type="number" min="0" className="w-20 border rounded p-2 text-center font-mono" value={quantities[p.id] || ''} onChange={e => handleQuantityChange(p.id, parseInt(e.target.value) || 0)} placeholder="0" /><span className="text-sm text-gray-500 w-8">{p.unit}</span></div></div>))}</div><textarea className="w-full border p-3 rounded-lg mb-6 text-sm" rows={3} placeholder="Note aggiuntive..." value={notes} onChange={e => setNotes(e.target.value)} /><div className="mb-6"><SignaturePad onSave={setSignature} onClear={() => setSignature(null)} /></div><div className="flex gap-3 pt-4 border-t"><button onClick={handleSubmit} className="flex-1 bg-emerald-600 text-white py-3 rounded-lg font-bold hover:bg-emerald-700 transition">Salva Inventario</button><button onClick={onCancel} className="px-6 py-3 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 font-medium">Annulla</button></div></div>); };
const NewOrderView: React.FC<{ structureId: string; currentUser: User; products: Product[]; inventories: InventoryReport[]; type: ItemType; onSave: (ord: any) => void; onCancel: () => void; }> = ({ structureId, currentUser, products, inventories, type, onSave, onCancel }) => { const filteredProducts = products.filter(p => p.type === type); const [quantities, setQuantities] = useState<Record<string, number>>({}); const handleSubmit = () => { const items: InventoryItem[] = Object.entries(quantities).filter(([_, q]) => q > 0).map(([pid, q]) => ({ productId: pid, quantity: q })); if (items.length === 0) { alert("Seleziona almeno un prodotto."); return; } onSave({ id: `ord-${Date.now()}`, structureId, requesterId: currentUser.id, dateCreated: new Date().toISOString(), status: OrderStatus.PENDING, items, type }); }; return (<div className="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow-lg"><h2 className="text-2xl font-bold mb-2 flex items-center gap-2"><ShoppingCart className="text-orange-500" /> Ordina {type === 'PRODUCT' ? 'Forniture' : 'Biancheria'}</h2><p className="text-gray-500 mb-6">Seleziona gli articoli necessari per il riassortimento.</p><div className="space-y-3 mb-8 max-h-[500px] overflow-y-auto">{filteredProducts.map(p => (<div key={p.id} className="flex justify-between items-center p-3 border rounded-lg hover:border-orange-300 transition-colors"><span className="font-medium">{p.name}</span><div className="flex items-center gap-2"><input type="number" min="0" className="w-20 border p-2 rounded text-center" placeholder="0" value={quantities[p.id] || ''} onChange={e => setQuantities({...quantities, [p.id]: parseInt(e.target.value) || 0})} /><span className="text-gray-400 text-sm w-8">{p.unit}</span></div></div>))}</div><div className="flex gap-3"><button onClick={handleSubmit} className="flex-1 bg-orange-600 text-white py-3 rounded-lg font-bold hover:bg-orange-700">Invia Ordine</button><button onClick={onCancel} className="px-6 bg-gray-100 text-gray-700 rounded-lg font-medium">Annulla</button></div></div>); };
const NewDamageReportView: React.FC<{ structureId: string; currentUser: User; products: Product[]; type: ItemType; onSave: (rep: any) => void; onCancel: () => void; }> = ({ structureId, currentUser, products, type, onSave, onCancel }) => { const [notes, setNotes] = useState(''); const handleSubmit = () => { if (!notes) { alert("Descrivi il problema."); return; } onSave({ id: `dmg-${Date.now()}`, structureId, reporterId: currentUser.id, date: new Date().toISOString(), items: [], notes, status: 'OPEN' }); }; return (<div className="max-w-xl mx-auto bg-white p-6 rounded-xl shadow-lg"><h2 className="text-2xl font-bold text-red-600 mb-4 flex items-center gap-2"><AlertTriangle /> Segnala Problema</h2><p className="mb-4 text-gray-600">Descrivi il guasto o l'oggetto danneggiato/mancante.</p><textarea className="w-full border p-4 rounded-lg h-40 mb-6 focus:ring-2 focus:ring-red-200 outline-none" placeholder="Esempio: La lampada sul comodino destro è rotta..." value={notes} onChange={e => setNotes(e.target.value)} /><div className="flex gap-3"><button onClick={handleSubmit} className="flex-1 bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700">Invia Segnalazione</button><button onClick={onCancel} className="px-6 bg-gray-100 text-gray-700 rounded-lg font-medium">Annulla</button></div></div>); };
const ManageOrdersView: React.FC<{ orders: Order[]; structures: Structure[]; products: Product[]; users: User[]; currentUser: User; targetType: ItemType; onUpdateOrder: (o: Order) => void; onDeleteOrder: (id: string) => void; }> = ({ orders, structures, products, users, currentUser, targetType, onUpdateOrder, onDeleteOrder }) => { const filteredOrders = orders.filter(o => o.type === targetType).sort((a,b) => new Date(b.dateCreated).getTime() - new Date(a.dateCreated).getTime()); const [editingOrderId, setEditingOrderId] = useState<string | null>(null); const [tempItems, setTempItems] = useState<InventoryItem[]>([]); const startEditing = (order: Order) => { setEditingOrderId(order.id); setTempItems([...order.items]); }; const cancelEditing = () => { setEditingOrderId(null); setTempItems([]); }; const saveEditing = (order: Order) => { const finalItems = tempItems.filter(i => i.quantity > 0); if (finalItems.length === 0) { alert("L'ordine non può essere vuoto. Eliminalo se necessario."); return; } onUpdateOrder({ ...order, items: finalItems }); setEditingOrderId(null); setTempItems([]); }; const updateTempItem = (productId: string, qty: number) => { setTempItems(prev => { const exists = prev.find(i => i.productId === productId); if (exists) { return prev.map(i => i.productId === productId ? { ...i, quantity: qty } : i); } return [...prev, { productId, quantity: qty }]; }); }; const handleStatusChange = (order: Order, newStatus: OrderStatus) => { onUpdateOrder({ ...order, status: newStatus, dateSent: newStatus === OrderStatus.SENT ? new Date().toISOString() : order.dateSent }); }; const canEdit = currentUser.role === Role.ADMIN || currentUser.role === Role.RECEPTION; const canSend = currentUser.role === Role.ADMIN || currentUser.role === Role.RECEPTION; const canDelete = (order: Order) => order.status === OrderStatus.PENDING && (currentUser.role === Role.ADMIN || currentUser.role === Role.RECEPTION || currentUser.id === order.requesterId); return (<div className="max-w-6xl mx-auto"><h2 className="text-2xl font-bold mb-6 flex items-center gap-2">{targetType === 'PRODUCT' ? <ShoppingCart /> : <Shirt />} Gestione Ordini {targetType === 'PRODUCT' ? 'Prodotti' : 'Biancheria'}</h2><div className="grid gap-4">{filteredOrders.map(order => { const struct = structures.find(s => s.id === order.structureId); const requester = users.find(u => u.id === order.requesterId); const isEditing = editingOrderId === order.id; return (<div key={order.id} className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col md:flex-row justify-between gap-6"><div className="flex-1"><div className="flex items-center gap-3 mb-2"><h3 className="font-bold text-lg">{struct?.name}</h3><span className={`text-xs px-2 py-1 rounded font-bold ${order.status === OrderStatus.PENDING ? 'bg-yellow-100 text-yellow-700' : order.status === OrderStatus.SENT ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}`}>{order.status}</span></div><p className="text-sm text-gray-500 mb-4">Richiesto da {requester?.name} il {new Date(order.dateCreated).toLocaleDateString()}</p><div className="bg-gray-50 p-3 rounded-lg">{isEditing ? (<div className="space-y-2"><p className="text-xs font-bold text-gray-500 mb-2">Modifica Quantità:</p>{products.filter(p => p.type === targetType).map(p => (<div key={p.id} className="flex justify-between items-center"><span className="text-sm">{p.name}</span><input type="number" min="0" className="w-16 border rounded p-1 text-center" value={tempItems.find(i => i.productId === p.id)?.quantity || 0} onChange={(e) => updateTempItem(p.id, parseInt(e.target.value) || 0)} /></div>))}</div>) : (<ul className="text-sm space-y-1">{order.items.map(item => { const p = products.find(prod => prod.id === item.productId); return <li key={item.productId} className="flex justify-between"><span>{p?.name}</span><span className="font-mono font-bold">{item.quantity} {p?.unit}</span></li> })}</ul>)}</div></div><div className="flex flex-col justify-center gap-2 min-w-[180px]">{order.status === OrderStatus.PENDING ? (<>{isEditing ? (<><button onClick={() => saveEditing(order)} className="bg-emerald-600 text-white py-2 rounded hover:bg-emerald-700 transition flex items-center justify-center gap-1"><Save size={16}/> Salva</button><button onClick={cancelEditing} className="bg-gray-200 text-gray-700 py-2 rounded hover:bg-gray-300 transition flex items-center justify-center gap-1"><XCircle size={16}/> Annulla</button></>) : (<>{canSend && (<button onClick={() => handleStatusChange(order, OrderStatus.SENT)} className="bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition flex items-center justify-center gap-2"><Send size={16} /> Approva e Invia</button>)}{canEdit && (<button onClick={() => startEditing(order)} className="border border-gray-300 text-gray-700 py-2 rounded hover:bg-gray-50 transition flex items-center justify-center gap-2"><Edit size={16} /> Modifica</button>)}{canDelete(order) && (<button onClick={() => onDeleteOrder(order.id)} className="border border-red-200 text-red-600 py-2 rounded hover:bg-red-50 transition flex items-center justify-center gap-2"><Trash2 size={16} /> Elimina</button>)}</>)}</>) : (<div className="text-sm text-gray-500 text-center p-2 bg-gray-50 rounded">Ordine {order.status === OrderStatus.SENT ? 'inviato' : 'consegnato'}.</div>)}</div></div>); })} {filteredOrders.length === 0 && (<div className="text-center py-10 bg-white rounded-xl text-gray-400">Nessun ordine trovato.</div>)}</div></div>); };
const SupplierDashboardView: React.FC<{ orders: Order[]; structures: Structure[]; products: Product[]; users: User[]; }> = ({ orders, structures, products }) => { const myOrders = orders.filter(o => o.status !== OrderStatus.PENDING && o.type === 'PRODUCT').sort((a,b) => new Date(b.dateCreated).getTime() - new Date(a.dateCreated).getTime()); return (<div className="max-w-6xl mx-auto"><h2 className="text-2xl font-bold mb-6">Pannello Fornitore</h2><div className="bg-white rounded-xl shadow-sm overflow-hidden"><table className="w-full text-left">
<thead className="bg-gray-50 border-b"><tr><th className="p-4">Data</th><th className="p-4">Struttura</th><th className="p-4">Articoli</th><th className="p-4">Stato</th></tr></thead><tbody>
{myOrders.map(order => { const struct = structures.find(s => s.id === order.structureId); return (<tr key={order.id} className="border-b last:border-0 hover:bg-gray-50"><td className="p-4 align-top">{new Date(order.dateCreated).toLocaleDateString()}</td><td className="p-4 align-top">{struct?.name}<br/><span className="text-xs text-gray-400">{struct?.address}</span></td><td className="p-4 align-top"><ul className="list-disc pl-4 text-sm space-y-1">{order.items.map((item, idx) => { const prod = products.find(p => p.id === item.productId); return <li key={idx}><b>{prod?.name}:</b> {item.quantity} {prod?.unit}</li> })}</ul></td><td className="p-4 align-top"><span className={`px-2 py-1 rounded text-xs font-bold ${order.status === 'DELIVERED' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>{order.status}</span></td></tr>); })}
{myOrders.length === 0 && (<tr><td colSpan={4} className="p-8 text-center text-gray-500">Nessun ordine assegnato.</td></tr>)}
</tbody></table></div></div>); };
const UserManagementView: React.FC<{ users: User[]; onAddUser: (u: any) => Promise<void>; onDeleteUser: (id: string) => Promise<void>; }> = ({ users, onAddUser, onDeleteUser }) => { const [newUser, setNewUser] = useState({ name: '', email: '', role: Role.OPERATOR, password: '' }); const handleAdd = async () => { if(!newUser.name || !newUser.email || !newUser.password) { alert("Tutti i campi sono obbligatori"); return; } await onAddUser({ id: `u-${Date.now()}`, ...newUser }); setNewUser({ name: '', email: '', role: Role.OPERATOR, password: '' }); }; return (<div className="max-w-4xl mx-auto"><h2 className="text-2xl font-bold mb-6 flex items-center gap-2"><Users /> Gestione Utenti</h2><div className="bg-white p-6 rounded-xl shadow-sm mb-8 border border-gray-100"><h3 className="font-bold mb-4">Aggiungi Utente</h3><div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4"><input placeholder="Nome" className="border p-2 rounded" value={newUser.name} onChange={e => setNewUser({...newUser, name: e.target.value})} /><input placeholder="Email" className="border p-2 rounded" value={newUser.email} onChange={e => setNewUser({...newUser, email: e.target.value})} /><input placeholder="Password" type="password" className="border p-2 rounded" value={newUser.password} onChange={e => setNewUser({...newUser, password: e.target.value})} /><select className="border p-2 rounded" value={newUser.role} onChange={e => setNewUser({...newUser, role: e.target.value as Role})}>{Object.values(Role).map(r => <option key={r} value={r} className="capitalize">{r}</option>)}</select></div><button onClick={handleAdd} className="bg-emerald-600 text-white px-4 py-2 rounded font-bold hover:bg-emerald-700 w-full md:w-auto">Aggiungi</button></div><div className="bg-white rounded-xl shadow-sm overflow-hidden"><table className="w-full text-left"><thead className="bg-gray-50 border-b"><tr><th className="p-4">Nome</th><th className="p-4">Email</th><th className="p-4">Ruolo</th><th className="p-4 w-20">Azioni</th></tr></thead><tbody>{users.map(u => (<tr key={u.id} className="border-b last:border-0 hover:bg-gray-50"><td className="p-4 font-medium">{u.name}</td><td className="p-4 text-gray-500">{u.email}</td><td className="p-4"><span className="bg-gray-100 px-2 py-1 rounded text-xs font-bold capitalize">{u.role}</span></td><td className="p-4 text-center"><button onClick={() => onDeleteUser(u.id)} className="text-red-500 hover:bg-red-50 p-2 rounded"><Trash2 size={18} /></button></td></tr>))}</tbody></table></div></div>); };
const ProductManagementView: React.FC<{ products: Product[]; onAddProduct: (p: any) => Promise<void>; onDeleteProduct: (id: string) => Promise<void>; }> = ({ products, onAddProduct, onDeleteProduct }) => { const [newProd, setNewProd] = useState<Partial<Product>>({ name: '', category: 'CLEANING', unit: 'Pz', type: 'PRODUCT' }); const handleAdd = async () => { if(!newProd.name || !newProd.unit) { alert("Nome e Unità sono obbligatori"); return; } await onAddProduct({ id: `p-${Date.now()}`, ...newProd }); setNewProd({ name: '', category: 'CLEANING', unit: 'Pz', type: 'PRODUCT' }); }; return (<div className="max-w-4xl mx-auto"><h2 className="text-2xl font-bold mb-6 flex items-center gap-2"><Box /> Catalogo Prodotti</h2><div className="bg-white p-6 rounded-xl shadow-sm mb-8 border border-gray-100"><h3 className="font-bold mb-4">Nuovo Prodotto</h3><div className="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4"><input placeholder="Nome Prodotto" className="border p-2 rounded col-span-2" value={newProd.name} onChange={e => setNewProd({...newProd, name: e.target.value})} /><select className="border p-2 rounded" value={newProd.category} onChange={e => setNewProd({...newProd, category: e.target.value as any})}><option value="CLEANING">Pulizia</option><option value="FOOD">Cibo/Bevande</option><option value="AMENITIES">Amenities</option><option value="LINEN_BED">Biancheria Letto</option><option value="LINEN_BATH">Biancheria Bagno</option><option value="OTHER">Altro</option></select><select className="border p-2 rounded" value={newProd.type} onChange={e => setNewProd({...newProd, type: e.target.value as any})}><option value="PRODUCT">Consumabile</option><option value="LINEN">Biancheria</option></select><input placeholder="Unità (es. Pz, Lt)" className="border p-2 rounded" value={newProd.unit} onChange={e => setNewProd({...newProd, unit: e.target.value})} /></div><button onClick={handleAdd} className="bg-emerald-600 text-white px-4 py-2 rounded font-bold hover:bg-emerald-700 w-full md:w-auto">Aggiungi a Catalogo</button></div><div className="bg-white rounded-xl shadow-sm overflow-hidden"><table className="w-full text-left"><thead className="bg-gray-50 border-b"><tr><th className="p-4">Prodotto</th><th className="p-4">Categoria</th><th className="p-4">Tipo</th><th className="p-4">Unità</th><th className="p-4 w-20">Azioni</th></tr></thead><tbody>{products.map(p => (<tr key={p.id} className="border-b last:border-0 hover:bg-gray-50"><td className="p-4 font-medium">{p.name}</td><td className="p-4 text-sm text-gray-500">{p.category}</td><td className="p-4"><span className={`px-2 py-1 rounded text-xs font-bold ${p.type === 'LINEN' ? 'bg-indigo-100 text-indigo-700' : 'bg-green-100 text-green-700'}`}>{p.type}</span></td><td className="p-4 text-sm text-gray-500">{p.unit}</td><td className="p-4 text-center"><button onClick={() => onDeleteProduct(p.id)} className="text-red-500 hover:bg-red-50 p-2 rounded"><Trash2 size={18} /></button></td></tr>))}</tbody></table></div></div>); };

export default App;
